#!/bin/bash

# Tribe Wrapper - Extends tribe CLI with custom commands
#
# This wrapper intercepts custom commands and routes them to our handlers,
# while passing all other commands to the real tribe CLI.
#
# Custom commands:
#   logs  - View interaction logs between User, ClawdBot, and agents
#   auth  - OAuth authentication for tribecode.ai
#   sync  - Sync sessions with tutor.tribecode.ai

TRIBE_BIN="$HOME/.tribe/bin/tribe"
BIN_DIR="$(dirname "$0")"
EXT_DIR="$(dirname "$BIN_DIR")"
LOGS_SCRIPT="$BIN_DIR/tribe-logs"
AUTH_SCRIPT="$BIN_DIR/tribe-auth"
SYNC_SCRIPT="$BIN_DIR/tribe-sync"

# Use local tsx from node_modules, fallback to npx
TSX_BIN="$EXT_DIR/node_modules/.bin/tsx"
if [ ! -f "$TSX_BIN" ]; then
    TSX_BIN="npx tsx"
fi

case "$1" in
    logs)
        shift
        if [ -f "$LOGS_SCRIPT" ]; then
            node "$LOGS_SCRIPT" "$@"
        else
            echo "Error: tribe-logs script not found at $LOGS_SCRIPT"
            exit 1
        fi
        ;;
    auth)
        shift
        if [ -f "$AUTH_SCRIPT" ]; then
            $TSX_BIN "$AUTH_SCRIPT" "$@"
        else
            echo "Error: tribe-auth script not found at $AUTH_SCRIPT"
            exit 1
        fi
        ;;
    sync)
        shift
        if [ -f "$SYNC_SCRIPT" ]; then
            $TSX_BIN "$SYNC_SCRIPT" "$@"
        else
            echo "Error: tribe-sync script not found at $SYNC_SCRIPT"
            exit 1
        fi
        ;;
    *)
        # Pass through to real tribe CLI
        if [ -f "$TRIBE_BIN" ]; then
            "$TRIBE_BIN" "$@"
        else
            echo "Error: tribe CLI not found at $TRIBE_BIN"
            echo "Run 'tribe_setup' to install it."
            exit 1
        fi
        ;;
esac
